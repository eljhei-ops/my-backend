<!DOCTYPE html>
<html>
<head>
    <title>View Users</title>
    <link rel="stylesheet" href="admin.css">
    <script src="admin.js"></script>

    <style>
        /* Improve table spacing */
        .table-container {
            width: 100%;
            overflow-x: auto;
        }
        .table th, .table td {
            padding: 12px 14px;
            text-align: left;
        }

        /* Modal styling */
        .modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; 
            height: 100%;
            background: rgba(0,0,0,0.55);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }
        .modal-box {
            background: white;
            width: 350px;
            padding: 22px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .modal-box input, .modal-box select {
            width: 100%;
            margin-bottom: 12px;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }
        .modal-box button {
            padding: 10px 16px;
            margin-right: 8px;
            cursor: pointer;
            border: none;
            border-radius: 6px;
        }
        .save-btn {
            background: #2d6cdf;
            color: white;
        }
        .cancel-btn {
            background: #aaa;
            color: white;
        }
    </style>
</head>

<body onload="requireAdmin(); loadUsers()">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <h2 class="logo-text">IT Dashboard</h2>
        <a href="it-dashboard.html">üè† Dashboard</a>
        <a href="add_user.html">‚ûï Add User</a>
        <a class="active" href="view_users.html">üìã View Users</a>
        <a href="#" onclick="logout()">üö™ Logout</a>
    </aside>

    <!-- MAIN PANEL -->
    <div class="main">

        <header class="topbar">
            <h1>User Management</h1>
        </header>

        <section class="content">

            <div class="card">
                <h2>All Users</h2>
                <p class="subtitle">Manage and update user accounts.</p>

                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Type</th>
                                <th>Date Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userTable"></tbody>
                    </table>
                </div>

            </div>

        </section>

    </div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
    <div class="modal-box">
        <h3>Edit User</h3>

        <label>Username</label>
        <input id="edit_username" type="text">

        <label>User Type</label>
        <select id="edit_usertype">
            <option value="IT">IT</option>
            <option value="Admin">Admin</option>
            <option value="Client">Client</option>
        </select>

        <label>New Password (optional)</label>
        <input id="edit_password" type="password" placeholder="Leave blank to keep existing">

        <p id="edit_msg"></p>

        <button class="save-btn" onclick="saveEdit()">Save</button>
        <button class="cancel-btn" onclick="closeModal()">Cancel</button>
    </div>
</div>

<script>
function loadUsers() {
    fetch("/api/admin/users")
    .then(r => r.json())
    .then(data => {
        const table = document.getElementById("userTable");
        table.innerHTML = "";

        if (!data.success) {
            table.innerHTML = "<tr><td colspan='5'>Failed to load users.</td></tr>";
            return;
        }

        data.users.forEach(user => {
            table.innerHTML += `
<tr>
    <td>${user.id}</td>
    <td>${user.user_name}</td>
    <td>${user.user_type}</td>
    <td>${new Date(user.date_created).toLocaleString()}</td>
    <td>
        <button onclick="openEdit(${user.id}, '${user.user_name}', '${user.user_type}')">Edit</button>
        <button onclick="deleteUser(${user.id})">Delete</button>
    </td>
</tr>`;
        });
    });
}

function deleteUser(id) {
    if (!confirm("Delete this user?")) return;

    fetch("/api/admin/users/" + id, { method: "DELETE" })
        .then(r => r.json())
        .then(data => {
            alert(data.message);
            loadUsers();
        });
}

function requireAdmin() {
    if (localStorage.getItem("user_type") !== "IT") {
        alert("Unauthorized");
        window.location.href = "login.html";
    }
}

let editUserId = null;

function openEdit(id, name, type) {
    editUserId = id;

    document.getElementById("edit_username").value = name;
    document.getElementById("edit_usertype").value = type;
    document.getElementById("edit_password").value = "";
    document.getElementById("edit_msg").innerText = "";

    document.getElementById("editModal").style.display = "flex";
}

function closeModal() {
    document.getElementById("editModal").style.display = "none";
}

async function saveEdit() {
    const username = document.getElementById("edit_username").value;
    const usertype = document.getElementById("edit_usertype").value;
    const password = document.getElementById("edit_password").value;

    const payload = {
        user_name: username,
        user_type: usertype
    };

    if (password.trim() !== "") {
        payload.pass_word = password.trim();
    }

    const res = await fetch(`${BACKEND}/api/admin/users/${editUserId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });

    const data = await res.json();

    const msg = document.getElementById("edit_msg");
    msg.textContent = data.message;
    msg.style.color = data.success ? "green" : "red";

    if (data.success) {
        setTimeout(() => {
            closeModal();
            loadUsers();
        }, 600);
    }
}
</script>

</body>
</html>
